{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\n * @perkos/config\n * Configuration management utilities for PerkOS services\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface EnvConfig<T extends Record<string, EnvVarConfig>> {\n  vars: T;\n  prefix?: string;\n  strict?: boolean;\n}\n\nexport interface EnvVarConfig {\n  required?: boolean;\n  default?: string | number | boolean;\n  type?: \"string\" | \"number\" | \"boolean\" | \"json\";\n  validator?: (value: string) => boolean;\n  transform?: (value: string) => unknown;\n}\n\nexport type ParsedConfig<T extends Record<string, EnvVarConfig>> = {\n  [K in keyof T]: T[K][\"type\"] extends \"number\"\n    ? number\n    : T[K][\"type\"] extends \"boolean\"\n    ? boolean\n    : T[K][\"type\"] extends \"json\"\n    ? unknown\n    : string;\n};\n\nexport interface ConfigValidationResult {\n  valid: boolean;\n  errors: string[];\n  warnings: string[];\n}\n\n// ============================================================================\n// Environment Variable Utilities\n// ============================================================================\n\n/**\n * Get environment variable with optional default\n */\nexport function getEnv(key: string, defaultValue?: string): string | undefined {\n  return process.env[key] ?? defaultValue;\n}\n\n/**\n * Get required environment variable (throws if missing)\n */\nexport function getRequiredEnv(key: string): string {\n  const value = process.env[key];\n  if (value === undefined || value === \"\") {\n    throw new Error(`Required environment variable ${key} is not set`);\n  }\n  return value;\n}\n\n/**\n * Get environment variable as number\n */\nexport function getEnvNumber(key: string, defaultValue?: number): number | undefined {\n  const value = process.env[key];\n  if (value === undefined) return defaultValue;\n  const parsed = parseFloat(value);\n  return isNaN(parsed) ? defaultValue : parsed;\n}\n\n/**\n * Get environment variable as boolean\n */\nexport function getEnvBoolean(key: string, defaultValue?: boolean): boolean | undefined {\n  const value = process.env[key];\n  if (value === undefined) return defaultValue;\n  return value.toLowerCase() === \"true\" || value === \"1\";\n}\n\n/**\n * Get environment variable as JSON\n */\nexport function getEnvJson<T>(key: string, defaultValue?: T): T | undefined {\n  const value = process.env[key];\n  if (value === undefined) return defaultValue;\n  try {\n    return JSON.parse(value) as T;\n  } catch {\n    return defaultValue;\n  }\n}\n\n// ============================================================================\n// Configuration Builder\n// ============================================================================\n\n/**\n * Create a typed configuration from environment variables\n */\nexport function createConfig<T extends Record<string, EnvVarConfig>>(\n  config: EnvConfig<T>\n): ParsedConfig<T> {\n  const result: Record<string, unknown> = {};\n  const prefix = config.prefix ? `${config.prefix}_` : \"\";\n\n  for (const [key, varConfig] of Object.entries(config.vars)) {\n    const envKey = `${prefix}${key}`;\n    const rawValue = process.env[envKey];\n\n    // Handle missing values\n    if (rawValue === undefined || rawValue === \"\") {\n      if (varConfig.required && config.strict !== false) {\n        throw new Error(`Required environment variable ${envKey} is not set`);\n      }\n      if (varConfig.default !== undefined) {\n        result[key] = varConfig.default;\n        continue;\n      }\n      result[key] = undefined;\n      continue;\n    }\n\n    // Validate\n    if (varConfig.validator && !varConfig.validator(rawValue)) {\n      throw new Error(`Invalid value for environment variable ${envKey}`);\n    }\n\n    // Transform or parse by type\n    if (varConfig.transform) {\n      result[key] = varConfig.transform(rawValue);\n      continue;\n    }\n\n    switch (varConfig.type) {\n      case \"number\":\n        const num = parseFloat(rawValue);\n        if (isNaN(num)) {\n          throw new Error(`Invalid number for environment variable ${envKey}`);\n        }\n        result[key] = num;\n        break;\n      case \"boolean\":\n        result[key] = rawValue.toLowerCase() === \"true\" || rawValue === \"1\";\n        break;\n      case \"json\":\n        try {\n          result[key] = JSON.parse(rawValue);\n        } catch {\n          throw new Error(`Invalid JSON for environment variable ${envKey}`);\n        }\n        break;\n      default:\n        result[key] = rawValue;\n    }\n  }\n\n  return result as ParsedConfig<T>;\n}\n\n/**\n * Validate configuration without creating it\n */\nexport function validateConfig<T extends Record<string, EnvVarConfig>>(\n  config: EnvConfig<T>\n): ConfigValidationResult {\n  const errors: string[] = [];\n  const warnings: string[] = [];\n  const prefix = config.prefix ? `${config.prefix}_` : \"\";\n\n  for (const [key, varConfig] of Object.entries(config.vars)) {\n    const envKey = `${prefix}${key}`;\n    const rawValue = process.env[envKey];\n\n    if (rawValue === undefined || rawValue === \"\") {\n      if (varConfig.required) {\n        errors.push(`Missing required: ${envKey}`);\n      } else if (varConfig.default === undefined) {\n        warnings.push(`Optional not set: ${envKey}`);\n      }\n      continue;\n    }\n\n    if (varConfig.validator && !varConfig.validator(rawValue)) {\n      errors.push(`Invalid value: ${envKey}`);\n    }\n\n    if (varConfig.type === \"number\" && isNaN(parseFloat(rawValue))) {\n      errors.push(`Invalid number: ${envKey}`);\n    }\n\n    if (varConfig.type === \"json\") {\n      try {\n        JSON.parse(rawValue);\n      } catch {\n        errors.push(`Invalid JSON: ${envKey}`);\n      }\n    }\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n  };\n}\n\n// ============================================================================\n// Service Discovery Configuration\n// ============================================================================\n\nexport interface ServiceInfo {\n  name: string;\n  version: string;\n  description?: string;\n  capabilities?: string[];\n  endpoints?: Record<string, EndpointInfo>;\n}\n\nexport interface EndpointInfo {\n  path: string;\n  method: \"GET\" | \"POST\" | \"PUT\" | \"DELETE\" | \"PATCH\";\n  description?: string;\n  price?: number;\n  rateLimit?: number;\n}\n\n/**\n * Create service discovery info\n */\nexport function createServiceInfo(info: ServiceInfo): ServiceInfo {\n  return {\n    ...info,\n    capabilities: info.capabilities || [],\n    endpoints: info.endpoints || {},\n  };\n}\n\n// ============================================================================\n// Price Configuration\n// ============================================================================\n\nexport interface PriceConfig {\n  [key: string]: number;\n}\n\n/**\n * Parse price from environment variable with fallback\n */\nexport function parsePrice(envVar: string | undefined, fallback: number): number {\n  if (!envVar) return fallback;\n  const parsed = parseFloat(envVar);\n  return isNaN(parsed) ? fallback : parsed;\n}\n\n/**\n * Create price configuration from environment\n */\nexport function createPriceConfig(\n  priceMap: Record<string, { envKey: string; default: number }>\n): PriceConfig {\n  const result: PriceConfig = {};\n  for (const [key, config] of Object.entries(priceMap)) {\n    result[key] = parsePrice(process.env[config.envKey], config.default);\n  }\n  return result;\n}\n\n// ============================================================================\n// Route Configuration\n// ============================================================================\n\nexport interface RouteConfig {\n  path: string;\n  price: number;\n  description?: string;\n  rateLimit?: number;\n}\n\n/**\n * Create route price mapping from price config\n */\nexport function createRouteMapping(\n  routes: Array<{ path: string; priceKey: string; description?: string }>,\n  prices: PriceConfig\n): Record<string, RouteConfig> {\n  const result: Record<string, RouteConfig> = {};\n  for (const route of routes) {\n    result[route.path] = {\n      path: route.path,\n      price: prices[route.priceKey] || 0,\n      description: route.description,\n    };\n  }\n  return result;\n}\n\n/**\n * Get price for a route path\n */\nexport function getRoutePrice(\n  routes: Record<string, RouteConfig>,\n  path: string\n): number | undefined {\n  const route = routes[path];\n  return route?.price;\n}\n\n// ============================================================================\n// Feature Flags\n// ============================================================================\n\nexport interface FeatureFlags {\n  [key: string]: boolean;\n}\n\n/**\n * Create feature flags from environment\n */\nexport function createFeatureFlags(\n  flags: Record<string, { envKey: string; default: boolean }>\n): FeatureFlags {\n  const result: FeatureFlags = {};\n  for (const [key, config] of Object.entries(flags)) {\n    const value = process.env[config.envKey];\n    result[key] =\n      value !== undefined\n        ? value.toLowerCase() === \"true\" || value === \"1\"\n        : config.default;\n  }\n  return result;\n}\n\n/**\n * Check if a feature is enabled\n */\nexport function isFeatureEnabled(\n  flags: FeatureFlags,\n  feature: string\n): boolean {\n  return flags[feature] ?? false;\n}\n"],"mappings":"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","names":[]}